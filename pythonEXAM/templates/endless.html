<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ— å°½åˆ·é¢˜æ¨¡å¼</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .q-category { background: #9b59b6; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.8em; margin-right: 8px; }
        .feedback { margin-top: 20px; padding: 15px; border-radius: 8px; display: none; line-height: 1.6; }
        .feedback.correct { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .feedback.wrong { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .fill-input { padding: 10px; width: 60%; font-size: 1.1em; border: 2px solid #bdc3c7; border-radius: 6px; }
        .btn-confirm { background: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 1em; margin-left: 10px; }
        .stats-bar { display: flex; justify-content: space-between; color: #7f8c8d; font-size: 0.9em; margin-bottom: 20px; }
        /* è°ƒæ•´æŒ‰é’®å¸ƒå±€ */
        .action-bar { margin-top: 15px; display: flex; gap: 10px; align-items: center; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/" class="back-link">â† é€€å‡º</a>
            <h2>â™¾ï¸ æ— å°½æŒ‘æˆ˜</h2>
        </div>

        <div class="stats-bar">
            <span>å·²æŒ‘æˆ˜: <span id="done-count">0</span> é¢˜</span>
            <span>é¢˜åº“å‰©ä½™: <span id="remain-count">--</span></span>
        </div>

        <div id="question-area" class="question-card">
            <div class="loading">æ­£åœ¨åŠ è½½é¢˜åº“...</div>
        </div>

        <button id="next-btn" class="btn" style="width:100%; display:none; margin-top:20px;" onclick="nextQuestion()">ä¸‹ä¸€é¢˜</button>
    </div>

    <script>
        let questionPool = [];
        let currentQ = null;
        let answeredIds = JSON.parse(localStorage.getItem('answeredIds') || '[]');

        // åˆå§‹åŒ–
        fetch('/api/all_questions')
            .then(res => res.json())
            .then(data => {
                questionPool = data.filter(q => !answeredIds.includes(q.id + q.type));
                document.getElementById('done-count').innerText = answeredIds.length;
                document.getElementById('remain-count').innerText = questionPool.length;
                nextQuestion();
            });

        function nextQuestion() {
            if (questionPool.length === 0) {
                document.getElementById('question-area').innerHTML = `<div style="text-align:center; padding:50px;"><h3>ğŸ‰ é¢˜åº“å·²åˆ·çˆ†ï¼</h3><p>ä½ çœŸæ˜¯å¤ªå¼ºäº†ï¼</p><button class="btn" onclick="clearProgress()">é‡ç½®è¿›åº¦</button></div>`;
                document.getElementById('next-btn').style.display = 'none';
                return;
            }

            currentQ = questionPool.pop();
            renderQuestion(currentQ);
            document.getElementById('next-btn').style.display = 'none';
            document.getElementById('remain-count').innerText = questionPool.length;
        }

        function renderQuestion(q) {
            let html = `<div class="q-content">
                <span class="q-category">${q.category}</span>
                <p class="q-text">${q.question}</p>
            </div>`;

            if (q.type === 'choice') {
                html += `<div class="options-list">`;
                q.options.forEach((opt, idx) => {
                    const label = ['A','B','C','D'][idx];
                    html += `<div class="option-item" onclick="checkChoice('${label}', this)">
                                <span class="opt-label">${label}.</span> ${opt}
                             </div>`;
                });
                html += `</div>`;
            } else if (q.type === 'true_false') {
                html += `<div class="options-list">
                            <div class="option-item" onclick="checkTF('T', this)">âœ… æ­£ç¡® (True)</div>
                            <div class="option-item" onclick="checkTF('F', this)">âŒ é”™è¯¯ (False)</div>
                         </div>`;
            } else if (q.type === 'fill_in') {
                html += `<div style="margin-top:20px;">
                            <input type="text" id="fill-val" class="fill-input" placeholder="è¯·è¾“å…¥ç­”æ¡ˆ" autocomplete="off">
                            <button class="btn-confirm" onclick="checkFill()">æäº¤</button>
                         </div>`;
            }

            // æ–°å¢ï¼šæ“ä½œæ ï¼ˆæŸ¥çœ‹ç­”æ¡ˆæŒ‰é’®ï¼‰
            html += `<div class="action-bar">
                        <button class="btn-peek" onclick="peekAnswer()">ğŸ‘€ æŸ¥çœ‹ç­”æ¡ˆ</button>
                     </div>
                     <div id="peek-box" class="peek-box"></div> <div id="feedback" class="feedback"></div>`;
            
            document.getElementById('question-area').innerHTML = html;
        }

        // --- æ–°å¢ï¼šæŸ¥çœ‹ç­”æ¡ˆé€»è¾‘ ---
        function peekAnswer() {
            const box = document.getElementById('peek-box');
            let displayAns = currentQ.answer;
            if (currentQ.type === 'true_false') {
                displayAns = currentQ.answer === 'T' ? 'æ­£ç¡® (True)' : 'é”™è¯¯ (False)';
            }
            box.innerHTML = `ğŸ’¡ å‚è€ƒç­”æ¡ˆï¼š${displayAns}`;
            box.style.display = 'block';
        }

        // --- åˆ¤åˆ†é€»è¾‘ (ä¿æŒä¸å˜) ---
        function showFeedback(isCorrect, correctAns) {
            const fb = document.getElementById('feedback');
            fb.style.display = 'block';
            if (isCorrect) {
                fb.className = 'feedback correct';
                fb.innerHTML = `<strong>ğŸ‰ å›ç­”æ­£ç¡®ï¼</strong>`;
            } else {
                fb.className = 'feedback wrong';
                fb.innerHTML = `<strong>âš ï¸ å›ç­”é”™è¯¯</strong><br>æ­£ç¡®ç­”æ¡ˆï¼š${correctAns}`;
            }
            document.getElementById('next-btn').style.display = 'block';
            document.getElementById('peek-box').style.display = 'none'; // å›ç­”åéšè—å·çœ‹æ¡†
            
            answeredIds.push(currentQ.id + currentQ.type);
            localStorage.setItem('answeredIds', JSON.stringify(answeredIds));
            document.getElementById('done-count').innerText = answeredIds.length;
        }

        function checkChoice(userVal, el) {
            if (document.querySelector('.disabled')) return;
            document.querySelectorAll('.option-item').forEach(e => e.classList.add('disabled'));
            const isCorrect = userVal === currentQ.answer;
            if (isCorrect) el.classList.add('correct-opt');
            else el.classList.add('wrong-opt');
            showFeedback(isCorrect, currentQ.answer);
        }

        function checkTF(userVal, el) {
            if (document.querySelector('.disabled')) return;
            document.querySelectorAll('.option-item').forEach(e => e.classList.add('disabled'));
            const isCorrect = userVal === currentQ.answer;
            if (isCorrect) el.classList.add('correct-opt');
            else el.classList.add('wrong-opt');
            const displayAns = currentQ.answer === 'T' ? 'æ­£ç¡® (True)' : 'é”™è¯¯ (False)';
            showFeedback(isCorrect, displayAns);
        }

        function checkFill() {
            const input = document.getElementById('fill-val');
            if (input.disabled) return;
            input.disabled = true;
            const userVal = input.value.trim();
            const isCorrect = userVal.replace(/\s/g, '').toLowerCase() === currentQ.answer.replace(/\s/g, '').toLowerCase();
            showFeedback(isCorrect, currentQ.answer);
        }

        function clearProgress() {
            if(confirm('ç¡®å®šè¦æ¸…ç©ºåˆ·é¢˜è®°å½•å—ï¼Ÿ')) {
                localStorage.removeItem('answeredIds');
                location.reload();
            }
        }
    </script>
</body>
</html>